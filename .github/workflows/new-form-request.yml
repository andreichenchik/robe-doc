name: New Form Request

on:
  issues:
    types: [opened]

concurrency:
  group: refine-issue-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  refine:
    if: |
      contains(github.event.issue.labels.*.name, 'feedbackForm') &&
      !contains(github.event.issue.labels.*.name, 'refined')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Refine Form Request
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Bash(gh issue view:*),Bash(gh issue edit:*),Bash(gh issue list:*),Read"
          prompt: |
            Read the file `.agent/prompts/refine-issue.md` for instructions.

            Apply those instructions to issue #${{ github.event.issue.number }}.

            Use these values for placeholders:
            - ISSUE_NUMBER = ${{ github.event.issue.number }}
            - SERVER_URL = ${{ github.server_url }}
            - REPOSITORY = ${{ github.repository }}

      # GH_PROJECT_TOKEN: classic PAT with `project` + `public_repo` scopes.
      # Passed as github_token because the action overrides GH_TOKEN internally.
      - name: Prioritize Issue
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GH_PROJECT_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --allowedTools "Bash(gh issue view:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Bash(gh project item-list:*),Bash(gh project item-edit:*),Bash(gh project field-list:*),Bash(gh project view:*),Read"
          prompt: |
            Read the file `.agent/prompts/prioritize-issue.md` for instructions.

            Apply those instructions to issue #${{ github.event.issue.number }}.

            Use these values for placeholders:
            - ISSUE_NUMBER = ${{ github.event.issue.number }}
            - PROJECT_NUMBER = 7
            - PROJECT_OWNER = ${{ github.repository_owner }}
